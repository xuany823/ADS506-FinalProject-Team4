---
title: "Discussion 3.1: Applying ETS Models to Mauna Loa CO₂ Data"
author: "Vinh Dao"
format: html
execute:
  echo: true
  warning: false
  message: false
---

## Introduction

This analysis applies Exponential Smoothing State Space (ETS) models to the Mauna Loa CO₂ dataset. I compare a manually specified model with an automatically selected model to forecast the last 12 months of data.

## 1) Load Libraries and Data

```{r}
library(readr)
library(tsibble)
library(fable)
library(feasts)
library(dplyr)
library(ggplot2)

# Update file_path to your CSV location before running
file_path <- "co2_mm_mlo.csv"

# Read the data (CSV from NOAA; monthly, gap-filled; 'average' used unless missing)
co2 <- read_csv(
  file_path,
  comment = "#",
  show_col_types = FALSE
) |>
  mutate(
    Month = yearmonth(sprintf("%d-%02d", year, month)),
    ppm = if_else(average < 0, deseasonalized, average)
  ) |>
  select(Month, ppm) |>
  as_tsibble(index = Month)

# Display first few rows
head(co2)
```

## 2) Split Data into Training and Testing Sets

I hold out the last 12 months as the test set to evaluate forecast accuracy.

```{r}
h <- 12
n <- nrow(co2)

train <- co2 |> slice_head(n = n - h)
test <- co2 |> slice_tail(n = h)

# Show the split dates
list(
  train_start = min(train$Month),
  train_end = max(train$Month),
  test_start = min(test$Month),
  test_end = max(test$Month)
)
```

## 3) Fit Models: Manual vs Auto-ETS

### Manual Model Selection

I manually specified **additive trend** and **additive seasonality** while allowing the algorithm to automatically select the error type. My reasoning:

- **Additive Trend**: CO₂ accumulation follows a consistent upward pattern driven by emissions. While the rate is accelerating slightly, the underlying physical process is additive in nature.

- **Additive Seasonality**: The seasonal cycle is driven by photosynthesis and respiration, which produces a regular yearly pattern with relatively stable amplitude over time.

- **Error Type**: I allowed automatic selection because forecast uncertainty characteristics are better determined from the data itself.

```{r}
fits <- train |>
  model(
    manual_ets = ETS(ppm ~ trend("A") + season("A")),
    auto_ets = ETS(ppm)
  )

fits

# Optional: View smoothing parameters
# report(fits %>% select(manual_ets))
```

The manual model resulted in **ETS(M,A,A)**, meaning the algorithm chose multiplicative errors. This matches the auto-selected model, confirming this specification is appropriate for the data.

## 4) Generate Forecasts and Evaluate Accuracy

```{r}
fc <- fits |> forecast(h = h)
acc <- fc |> accuracy(test)

# Display accuracy metrics sorted by RMSE
acc |> 
  select(.model, .type, RMSE, MAE, MAPE) |>
  arrange(RMSE)
```

Both models produce identical results, which validates that ETS(M,A,A) is the appropriate model for this dataset.

## 5) Visualize Forecasts with Test Data

### Manual ETS Model

```{r}
autoplot(train, ppm) +
  autolayer(fc |> filter(.model == "manual_ets"), level = c(80, 95)) +
  autolayer(test, ppm, colour = "black", linewidth = 1) +
  labs(
    title = "Manual ETS (M,A,A) Forecast",
    subtitle = "Additive trend and season specified; multiplicative errors selected automatically",
    caption = "Black line = held-out 12-month test data; shaded = 80%/95% PI.",
    y = expression("CO"[2] * " (ppm)"),
    x = NULL
  ) +
  theme_minimal()
```

### Auto-ETS Model

```{r}
autoplot(train, ppm) +
  autolayer(fc |> filter(.model == "auto_ets"), level = c(80, 95)) +
  autolayer(test, ppm, colour = "black", linewidth = 1) +
  labs(
    title = "Auto-Selected ETS (M,A,A) Forecast",
    subtitle = "Fully automatic model selection",
    caption = "Black line = held-out 12-month test data; shaded = 80%/95% PI.",
    y = expression("CO"[2] * " (ppm)"),
    x = NULL
  ) +
  theme_minimal()
```

The black line shows the actual test data, which falls within the prediction intervals for both models.

## 6) Residual Diagnostics

```{r}
fits |>
  select(auto_ets) |>
  gg_tsresiduals()
```

The residual plots show:

- Residuals are centered around zero with no clear pattern
- ACF shows most lags within confidence bounds
- Distribution is approximately normal

These diagnostics suggest the model fits the data well.

## 7) Summary and Conclusions

**Dataset**: Monthly Mauna Loa CO₂ measurements from 1958 to 2025

*Source: NOAA ESRL Mauna Loa (monthly, with gap-filled "deseasonalized"/"average" columns).*

**Models Compared**:

- Manual: ETS with additive trend and season (automatic error selection)
- Auto: Fully automatic ETS selection

**Results** (test = last 12 months):

- Both models **converged** to **ETS(M,A,A)**
- **Test RMSE**: 0.231 ppm | **Test MAE**: 0.213 ppm; observed test values lie within the 80%/95% PI.

**Model Selection**: 

- **Manual**: ETS with additive trend and season (`trend('A') + season('A')`), error chosen automatically → ETS(M,A,A).
- **Auto**: Fully automatic ETS → ETS(M,A,A).

I compared these two approaches. Both converged to **ETS(M,A,A)**, validating that specification for this dataset.

**Interpretation**: The **multiplicative error** implies forecast uncertainty increases with the CO₂ level, which is reasonable for a rising series.

**Final Selection**: Because both models produce ETS(M,A,A) and the same test RMSE/MAE, I select the **manual** specification for transparency and interpretability (trend/season fixed, error learned).
