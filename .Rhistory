x = "Year", y = "CO2 (ppm)",
caption = "Red line: Test observations (20% of data 2010-2015)"
)
accuracy(co2_fc, test)
report(dplyr::select(co2_fit, auto_tslm))
report(dplyr::select(co2_fit, manual_tslm))
co2_fit |>
select(auto_tslm) |>
gg_tsresiduals() +
labs(title = "Residual Diagnostics - Auto TSLM (trend only)")
co2_fit |>
select(manual_tslm) |>
gg_tsresiduals() +
labs(title = "Residual Diagnostics - Manual TSLM (trend + season)")
co2_res <- augment(co2_fit)   # 包含 .fitted, .resid, .model 等列
# 看每个模型残差分布的 summary
co2_res |>
group_by(.model) |>
summarise(
mean_resid = mean(.resid, na.rm = TRUE),
sd_resid   = sd(.resid, na.rm = TRUE)
)
co2_res |>
group_by(.model) |>
features(.resid, ljung_box, lag = 24)   # lag 可以写 24 或一个季节以上
# 假设你已经有 train（80%）和 test（20%）
# train: 1958-03 ~ 2010-08
# test : 2010-09 ~ 2025-08
# 1. 建 rolling-origin 交叉验证样本
#   .init：第一次训练窗口的长度（比如前 10 年 = 120 个月，可以按需要调整）
#   .step：每次向前滚动多少期（例如 12 个月）
co2_cv <- train |>
stretch_tsibble(.init = 120, .step = 12)
# 2. 在每一个 rolling window 上拟合同一个模型
cv_fit <- co2_cv |>
model(
manual_tslm = TSLM(average ~ trend() + season())
# 如果你想比较 auto_tslm 也可以一起加上：
# auto_tslm   = TSLM(average ~ trend())
)
# 3. 对每个 rolling origin 做固定 horizon 的 forecast（比如 12 个月）
cv_fc <- cv_fit |>
forecast(h = "12 months")
# 4. 计算每个 origin 的预测误差
# 注意：这里用 train 作为 truth，因为我们只在训练集内部滚动
cv_acc <- cv_fc |>
accuracy(train, by = c(".model", ".id"))
# 5. 汇总成每个模型的平均误差指标（表格）
cv_summary <- cv_acc |>
group_by(.model) |>
summarise(
mean_RMSE = mean(RMSE, na.rm = TRUE),
mean_MAE  = mean(MAE,  na.rm = TRUE),
mean_MAPE = mean(MAPE, na.rm = TRUE)
)
cv_summary
cv_acc |>
filter(.model == "manual_tslm") |>
ggplot(aes(x = .id, y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
#x = "Origin window index",
#y = "RMSE (12-month-ahead forecasts)"
)
View(train)
# Rolling-origin time series cross-validation using stretch_tsibble()
# 初始窗口用前 80% 的样本，对应 n_train
co2_tr <- co2 |>
stretch_tsibble(.init = n_train, .step = 12) |>
relocate(Month, .id)   # 和书里 relocate(Date, Symbol, .id) 类似，这里只有 Month
co2_tr
# 在每个 rolling 窗口上拟合 Manual TSLM，并做 12 个月前瞻预测
co2_cv_fc <- co2_tr |>
model(
manual_tslm = TSLM(average ~ trend() + season())
) |>
forecast(h = 12)
# Time series cross-validation accuracy（rolling-origin）
cv_accuracy <- co2_cv_fc |>
accuracy(co2)
cv_accuracy
cv_acc |>
filter(.model == "manual_tslm") |>
ggplot(aes(x = .id, y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
#x = "Origin window index",
#y = "RMSE (12-month-ahead forecasts)"
)
# 作为对比：在完整样本上的训练集精度（非 rolling-origin）
train_accuracy <- co2 |>
model(
manual_tslm = TSLM(average ~ trend() + season())
) |>
accuracy()
train_accuracy
library(dplyr)
library(ggplot2)
rmse_by_origin <- co2_cv_fc |>
accuracy(co2, by = c(".id", ".model")) |>
select(.id, .model, RMSE)
ggplot(rmse_by_origin, aes(x = as.integer(.id), y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
x = "Origin window index",
y = "RMSE (12-month-ahead forecasts)"
)
# Rolling-origin time series cross-validation using stretch_tsibble()
# 初始窗口用前 80% 的样本，对应 n_train
co2_tr <- co2 |>
stretch_tsibble(.init = n_train, .step = 12) |>
#relocate(Month, .id)   # 和书里 relocate(Date, Symbol, .id) 类似，这里只有 Month
co2_tr
# Rolling-origin time series cross-validation using stretch_tsibble()
# 初始窗口用前 80% 的样本，对应 n_train
co2_tr <- co2 |>
stretch_tsibble(.init = n_train, .step = 12) |>
relocate(Month, .id)   # 和书里 relocate(Date, Symbol, .id) 类似，这里只有 Month
co2_tr
# 在每个 rolling 窗口上拟合 Manual TSLM，并做 12 个月前瞻预测
co2_cv_fc <- co2_tr |>
model(
manual_tslm = TSLM(average ~ trend() + season())
) |>
forecast(h = 12)|>
group_by(.id, .model) |>
mutate(h = row_number()) |>   # h = 1,2,...,12 (forecast horizon)
ungroup() |>
as_fable(response = "average", distribution = average)
co2_cv_fc
# 按 “预测步数 h” 汇总的 TSCV 准确度
fc |>
accuracy(co2, by = c("h", ".model")) |>
ggplot(aes(x = h, y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
x = "Forecast horizon (months)",
y = "RMSE"
)
# 按 “预测步数 h” 汇总的 TSCV 准确度
co2_cv_fc |>
accuracy(co2, by = c("h", ".model")) |>
ggplot(aes(x = h, y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
x = "Forecast horizon (months)",
y = "RMSE"
)
rmse_by_origin <- co2_cv_fc |>
accuracy(co2, by = c(".id", ".model")) |>
select(.id, .model, RMSE)
ggplot(rmse_by_origin, aes(x = as.integer(.id), y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
x = "Origin window index",
y = "RMSE (12-month-ahead forecasts)"
)
rmse_by_origin <- co2_cv_fc |>
accuracy(co2, by = c(".id", ".model")) |>
select(.id, .model, RMSE)
ggplot(rmse_by_origin, aes(x = as.integer(.id), y = RMSE)) +
geom_line() +
geom_point() +
labs(
title = "Rolling-Origin Cross-Validation – Manual TSLM",
x = ".id",
y = "RMSE (12-month-ahead forecasts)"
)
features(co2, features_boxcox)
#| message: false
#| warning: false
library(tidyverse)
library(fpp3)
library(gt)
library(feasts)
#library(urca)
co2_raw <- read_csv("data/co2.csv")
# 1. Basic cleaning / handle missing values
sum(is.na(co2_raw))
# 2. Create a proper time index and tsibble
co2_ts <- co2_raw |>
mutate(Month = yearmonth(paste(year, month, "01", sep = "-"))) |>
as_tsibble(index = Month)
# 3. Confirm tsibble
co2_ts |>
knitr::kable(digits = 1, caption = "Overall summary of CO2 average" )
#4. Summary of co2 data
co2_ts |>
summarise(
start_year   = min(year(Month)),
end_year     = max(year(Month)),
n_months     = n(),
mean_co2     = mean(average, na.rm = TRUE),
sd_co2       = sd(average, na.rm = TRUE),
min_co2      = min(average, na.rm = TRUE),
max_co2      = max(average, na.rm = TRUE),
mean_deseas  = mean(deseasonalized, na.rm = TRUE))
co2_ts |>
knitr::kable(digits = 1, caption = "Overall summary of CO2 average" )
# 5. Time Seires Plot
# 5.1 all raw data time series plot
co2_ts |>
autoplot(average) +
labs(title = "Monthly Mauna Loa CO2 (ppm)",
x = "Year",y = "CO2 (ppm)")
# 5.2. plot of latest 20 years
latest_year <- max(year(co2_ts$Month), na.rm = TRUE)
co2_ts |>
filter(year(Month) >= latest_year - 20) |>
autoplot(average) +
labs(title = "Monthly Mauna Loa CO2 (ppm), Last 20 Years",
x = "Year", y = "CO2 (ppm)")
# 5.3 Compare average and deseasonalized
co2_ts |>pivot_longer(
cols = c(average, deseasonalized), names_to = "series", values_to = "value") |>
autoplot(value) +
labs(title = "Mauna Loa CO2: Raw vs. Deseasonalized",
x = "Year",
y = "CO2 (ppm)")
#
# 6.1 Seasonal Plot
co2_ts |>
gg_season(average) +
labs(title = "Seasonal Plot of Monthly CO2", y = "CO₂ (ppm)",x = "Month")
# 6.2 Subseries plot
co2_ts |>
gg_subseries(average) +
labs(title = "Subseries Plot of Monthly CO2 by Month",
y = "CO₂ (ppm)", x = "Year")
# 7. Distribution & outliers
# 7.1 Histogram of CO2
co2_ts |>
ggplot(aes(x = average)) +
geom_histogram(bins = 30) +
labs(
title = "Distribution of Monthly CO₂",
x = "CO2 (ppm)",
y = "Count"
)
# 7.2 Boxplot by month
co2_ts |>
mutate(Month_f = factor(month(Month, label = TRUE))) |>
ggplot(aes(x = Month_f, y = average)) +
geom_boxplot() +
labs(
title = "Monthly CO₂ Distribution by Calendar Month",
x = "Month",
y = "CO₂ (ppm)"
)
# 7.3 Boxplot by decade
co2_ts |>
mutate(decade = factor((year(Month) %/% 10) * 10)) |>
ggplot(aes(x = decade, y = average)) +
geom_boxplot() +
labs(
title = "CO₂ Levels by Decade",
x = "Decade",
y = "CO₂ (ppm)"
)
# 8. Autocorrelation & decomposition
# 8.1 ACF of CO₂
co2_ts |>
ACF(average) |>
autoplot() +
labs(title = "ACF of Monthly CO2", x = "Lag (months)", y = "ACF")
# 8.2 STL decomposition (trend + season + remainder)
co2_stl <- co2_ts |>
model(stl = STL(average ~ season(window = "periodic"))) |>
components()
autoplot(co2_stl) + labs(title = "STL Decomposition of Monthly CO2")
# 9. Simple check on ndays / data quality
# Relationship between ndays and average CO2
co2_ts |>
ggplot(aes(x = ndays, y = average)) +
geom_point(alpha = 0.6) +
labs(title = "Relationship between Number of Days Sampled and Monthly CO2",
x = "Number of Days (ndays)",
y = "CO2 (ppm)"
)
# Trend of measurement uncertainty over time
co2_ts |> autoplot(unc) + labs(
title = "Measurement Uncertainty (unc) Over Time",
x = "Year", y = "Uncertainty")
#
# 6.1 Seasonal Plot
co2_ts |>
gg_season(average) +
labs(title = "Seasonal Plot of Monthly CO2", y = "CO2 (ppm)",x = "Month")
# 6.2 Subseries plot
co2_ts |>
gg_subseries(average) +
labs(title = "Subseries Plot of Monthly CO2 by Month",
y = "CO2 (ppm)", x = "Year")
# 7. Distribution & outliers
# 7.1 Histogram of CO2
co2_ts |>
ggplot(aes(x = average)) +
geom_histogram(bins = 30) +
labs(
title = "Distribution of Monthly CO₂",
x = "CO2 (ppm)",
y = "Count"
)
# 7.2 Boxplot by month
co2_ts |>
mutate(Month_f = factor(month(Month, label = TRUE))) |>
ggplot(aes(x = Month_f, y = average)) +
geom_boxplot() +
labs(
title = "Monthly CO₂ Distribution by Calendar Month",
x = "Month",
y = "CO₂ (ppm)"
)
# 7.3 Boxplot by decade
co2_ts |>
mutate(decade = factor((year(Month) %/% 10) * 10)) |>
ggplot(aes(x = decade, y = average)) +
geom_boxplot() +
labs(
title = "CO₂ Levels by Decade",
x = "Decade",
y = "CO₂ (ppm)"
)
# 7. Distribution & outliers
# 7.1 Histogram of CO2
co2_ts |>
ggplot(aes(x = average)) +
geom_histogram(bins = 30) +
labs(
title = "Distribution of Monthly CO2",
x = "CO2 (ppm)",
y = "Count"
)
# 7.2 Boxplot by month
co2_ts |>
mutate(Month_f = factor(month(Month, label = TRUE))) |>
ggplot(aes(x = Month_f, y = average)) +
geom_boxplot() +
labs(
title = "Monthly CO2 Distribution by Calendar Month",
x = "Month",
y = "CO2 (ppm)"
)
# 7.3 Boxplot by decade
co2_ts |>
mutate(decade = factor((year(Month) %/% 10) * 10)) |>
ggplot(aes(x = decade, y = average)) +
geom_boxplot() +
labs(
title = "CO2 Levels by Decade",
x = "Decade",
y = "CO2 (ppm)"
)
View(co2)
View(co2_cv)
View(co2_raw)
View(co2_raw)
fit <- co2_ts |>
model(
arima = ARIMA(average))
#| message: false
#| warning: false
library(tidyverse)
library(fpp3)
library(gt)
library(feasts)
#library(urca)
co2_raw <- read_csv("data/co2.csv")
# 1. Basic cleaning / handle missing values
sum(is.na(co2_raw))
# 2. Create a proper time index and tsibble
co2_ts <- co2_raw |>
mutate(Month = yearmonth(paste(year, month, "01", sep = "-"))) |>
as_tsibble(index = Month)
# 3. Confirm tsibble
co2_ts |>
knitr::kable(digits = 1, caption = "Overall summary of CO2 average" )
#4. Summary of co2 data
co2_ts |>
summarise(
start_year   = min(year(Month)),
end_year     = max(year(Month)),
n_months     = n(),
mean_co2     = mean(average, na.rm = TRUE),
sd_co2       = sd(average, na.rm = TRUE),
min_co2      = min(average, na.rm = TRUE),
max_co2      = max(average, na.rm = TRUE),
mean_deseas  = mean(deseasonalized, na.rm = TRUE))
co2_ts |>
knitr::kable(digits = 1, caption = "Overall summary of CO2 average" )
# 5. Time Seires Plot
# 5.1 all raw data time series plot
co2_ts |>
autoplot(average) +
labs(title = "Monthly Mauna Loa CO2 (ppm)",
x = "Year",y = "CO2 (ppm)")
# 5.2. plot of latest 20 years
latest_year <- max(year(co2_ts$Month), na.rm = TRUE)
co2_ts |>
filter(year(Month) >= latest_year - 20) |>
autoplot(average) +
labs(title = "Monthly Mauna Loa CO2 (ppm), Last 20 Years",
x = "Year", y = "CO2 (ppm)")
# 5.3 Compare average and deseasonalized
co2_ts |>pivot_longer(
cols = c(average, deseasonalized), names_to = "series", values_to = "value") |>
autoplot(value) +
labs(title = "Mauna Loa CO2: Raw vs. Deseasonalized",
x = "Year",
y = "CO2 (ppm)")
#
# 6.1 Seasonal Plot
co2_ts |>
gg_season(average) +
labs(title = "Seasonal Plot of Monthly CO2", y = "CO2 (ppm)",x = "Month")
# 6.2 Subseries plot
co2_ts |>
gg_subseries(average) +
labs(title = "Subseries Plot of Monthly CO2 by Month",
y = "CO2 (ppm)", x = "Year")
# 7. Distribution & outliers
# 7.1 Histogram of CO2
co2_ts |>
ggplot(aes(x = average)) +
geom_histogram(bins = 30) +
labs(
title = "Distribution of Monthly CO2",
x = "CO2 (ppm)",
y = "Count"
)
# 7.2 Boxplot by month
co2_ts |>
mutate(Month_f = factor(month(Month, label = TRUE))) |>
ggplot(aes(x = Month_f, y = average)) +
geom_boxplot() +
labs(
title = "Monthly CO2 Distribution by Calendar Month",
x = "Month",
y = "CO2 (ppm)"
)
# 7.3 Boxplot by decade
co2_ts |>
mutate(decade = factor((year(Month) %/% 10) * 10)) |>
ggplot(aes(x = decade, y = average)) +
geom_boxplot() +
labs(
title = "CO2 Levels by Decade",
x = "Decade",
y = "CO2 (ppm)"
)
# 8. Autocorrelation & decomposition
# 8.1 ACF of CO₂
co2_ts |>
ACF(average) |>
autoplot() +
labs(title = "ACF of Monthly CO2", x = "Lag (months)", y = "ACF")
# 8.2 STL decomposition (trend + season + remainder)
co2_stl <- co2_ts |>
model(stl = STL(average ~ season(window = "periodic"))) |>
components()
autoplot(co2_stl) + labs(title = "STL Decomposition of Monthly CO2")
# 9. Simple check on ndays / data quality
# Relationship between ndays and average CO2
co2_ts |>
ggplot(aes(x = ndays, y = average)) +
geom_point(alpha = 0.6) +
labs(title = "Relationship between Number of Days Sampled and Monthly CO2",
x = "Number of Days (ndays)",
y = "CO2 (ppm)"
)
# Trend of measurement uncertainty over time
co2_ts |> autoplot(unc) + labs(
title = "Measurement Uncertainty (unc) Over Time",
x = "Year", y = "Uncertainty")
fit <- co2_ts |>
model(
arima = ARIMA(average))
fit |>
select(arima) |>
gg_tsresiduals()
# KPSS Test
co2_ts |> features(average, unitroot_kpss)
# KPSS Test
co2_ts |> features(average, unitroot_kpss) |>
knitr::kable(digits = 1)
# KPSS Test
co2_ts |> features(average, unitroot_kpss) |>
knitr::kable(digits = 1)
# ACF
co2_ts |>
ACF(average) |>
autoplot()
# PACF
co2_ts |>
PACF(average) |>
autoplot()
co2_ts |>
ACF(average, lag_max = 48) |>
autoplot()
View(cv_acc)
